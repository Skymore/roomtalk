# RoomTalk

[English Version](./README.md)

一个基于 WebSocket 和 Redis 的轻量级实时消息系统，支持房间管理、消息持久化、本地主题切换等功能。适合作为 IM、团队协作、聊天室功能的基础模块。

**当前版本: 0.3** (新增头像和用户名显示)

---

## 🚀 技术栈

### 客户端（Client）

- React + TypeScript
- Tailwind CSS
- React Router
- Socket.io Client
- i18next 多语言支持

### 服务端（Server）

- Node.js + Express.js
- Socket.io
- Redis（数据持久化）
- UUID 用户标识

---

## 🔧 技术挑战

### 移动设备上的WebSocket连接可靠性

我们面临的最显著挑战之一是在移动设备上保持WebSocket连接的可靠性，特别是当应用在前台和后台状态之间切换时。

#### 问题
- 当移动应用切换到后台时，浏览器可能会暂停WebSocket连接
- 即使连接看似活跃，事件监听器也常常变得无响应
- 用户可以发送消息（通过HTTP回退机制），但无法接收消息，除非刷新页面
- 不同浏览器和移动平台对后台连接的处理方式各不相同

#### 解决方案
我们实现了多层次的方法来确保连接可靠性：

1. **增强的Socket.io配置**
   - 配置自动重连机制，优化超时和延迟参数
   - 实现连接状态跟踪，检测"僵尸"连接
   - 添加传输回退机制（WebSocket → HTTP轮询）

2. **事件监听器管理**
   - 创建系统检测并重新绑定无响应的事件监听器
   - 实现事件引用跟踪，防止重复绑定事件
   - 添加消息去重功能，防止重连后消息重复显示

3. **基于可见性的恢复机制**
   - 利用页面可见性API检测应用何时返回前台
   - 在可见性变化时实现连接健康检查
   - 从后台状态返回时自动刷新消息数据

4. **活动房间跟踪**
   - 维护客户端活动房间参与记录
   - 连接重新建立后自动重新加入房间
   - 实现服务器端会话恢复机制

这种综合方法确保了在不同设备和网络条件下消息传递的可靠性，即使在复杂的移动环境中也能维持无缝的用户体验。

---

## 🌟 功能特点

- ✅ 实时消息收发
- ✅ 加入或创建房间
- ✅ 本地保存房间列表
- ✅ 消息与房间数据持久化（使用 Redis）
- ✅ 暗色/亮色模式切换
- ✅ 响应式设计（适用于手机与桌面）
- ✅ 中英文多语言支持
- ✅ 图片消息支持（v0.2版本新增）
  - 丰富的媒体消息，单条支持最多9张图片
  - 直观的图片处理（剪贴板粘贴、文件上传）
  - 混合内容编辑（文字和图片共存）
- ✅ 用户身份系统（v0.3版本新增）
  - 基于用户名生成个性化头像
  - 聊天消息显示用户名
  - 改进聊天界面，提供更好的消息归属视觉提示

---

## 🧪 快速开始

### 环境准备

- 安装 Node.js
- 安装并运行本地 Redis（默认地址：`localhost:6379`）

### 安装依赖

```bash
# 安装服务端依赖
cd server
npm install

# 安装客户端依赖
cd ../client
npm install
```

### 启动系统

你可以使用脚本一键启动：

```bash
./start.sh
```

或者分开启动：

```bash
# 启动服务端
cd server
npm start

# 启动客户端
cd ../client
npm run dev
```

---

## 🧭 使用说明

1. 打开浏览器访问 [http://localhost:3011](http://localhost:3011)
2. 页面将自动为用户分配唯一 ID（存储在 localStorage）
3. 创建房间、加入房间、开始聊天

---

## 🔌 API 接口说明

### HTTP 接口

| 路径 | 方法 | 描述 |
|-----------------------------------------------|--------|------------------------------------------------|
| `/api/rooms/:roomId/messages`                 | `GET`  | 获取指定房间的消息                             |
| `/api/clients/:clientId/rooms`                | `GET`  | 获取指定用户创建的房间列表                     |
| `/api/clients/:clientId/rooms`                | `POST` | 为指定用户创建新房间                           |
| `/api/clients/:clientId/rooms/:roomId`          | `GET`  | 获取指定房间的详细信息（仅限房间创建者）         |
| `/api/rooms/:roomId/messages`                 | `POST` | 向指定房间发送消息                             |

### WebSocket 事件

| 事件名            | 方向         | 描述                                          |
|-------------------|--------------|-----------------------------------------------|
| `register`        | 客户端 → 服务端 | 注册用户，并加入以 clientId 命名的分组            |
| `get_rooms`       | 客户端 → 服务端 | 请求获取当前用户创建的房间                      |
| `create_room`     | 客户端 → 服务端 | 创建房间                                      |
| `join_room`       | 客户端 → 服务端 | 加入房间                                      |
| `leave_room`      | 客户端 → 服务端 | 离开房间                                      |
| `send_message`    | 客户端 → 服务端 | 发送消息到指定房间                            |
| `get_room_by_id`  | 客户端 → 服务端 | 根据房间 ID 请求房间详情                        |
| `message_history` | 服务端 → 客户端 | 返回房间消息历史                              |
| `new_room`        | 服务端 → 客户端 | 推送新房间信息（仅发送给房间创建者）             |
| `new_message`     | 服务端 → 客户端 | 向房间广播新消息                              |

---

## ⚙️ 配置

### 服务端 `.env`

| 变量名       | 默认值                  | 说明       |
|--------------|-------------------------|------------|
| `PORT`       | 3012                    | 服务端端口 |
| `CLIENT_URL` | http://localhost:3011    | CORS 配置  |

### 客户端 `.env`

**.env.development:**

| 变量名            | 默认值                  | 说明              |
|-------------------|-------------------------|-------------------|
| `VITE_SOCKET_URL` | http://localhost:3012    | WebSocket 地址    |

**.env.production:**

| 变量名            | 默认值 | 说明                                  |
|-------------------|--------|---------------------------------------|
| `VITE_SOCKET_URL` | `/`    | 同域部署时使用相对路径                 |

---

## 📦 Redis 持久化

系统默认使用 **RDB 快照** 方式持久化。你可以通过修改 `redis.conf` 来启用 **AOF** 或调整保存策略。

---

## 📄 许可证

MIT License

版权所有 (c) 2024 RoomTalk

特此免费授予任何获得本软件及相关文档文件（以下简称"软件"）副本的人，不受限制地处理本软件的权利，包括但不限于使用、复制、修改、合并、出版、分发、再许可及/或销售软件的副本，并允许其受让人如此做，但须符合以下条件：

上述版权声明及本许可声明应包含在本软件的所有副本或主要部分中。

本软件按"原样"提供，不附带任何明示或暗示的保证，包括但不限于对适销性、特定用途适用性及非侵权性的保证。在任何情况下，作者或版权持有人均不对因软件或软件的使用或其他交易产生的任何索赔、损害或其他责任承担责任，无论是在合同、侵权或其他方面。

## 📝 版本历史

### v0.3 - 用户身份系统
- **个性化头像**：实现基于用户名的头像生成，带有一致性颜色标识
  - 开发了智能头像文本提取算法，同时支持英文首字母和中文汉字处理
  - 创建了基于哈希算法的颜色映射，确保用户标识的一致性
  - 实现了缺失头像信息时的图标回退系统
- **增强聊天体验**：为每条消息添加用户名显示，提高对话清晰度
  - 扩展了Message数据结构，添加了username和avatar字段
  - 修改了socket通信机制，使每条消息都携带用户身份信息
  - 在Redis中持久化用户身份数据，确保消息历史记录的一致性
- **界面优化**：重新设计聊天界面，更好地指示消息所有权，简化房间信息显示
  - 根据消息所有权应用条件样式
  - 为各种屏幕尺寸优化头像显示
  - 实现了组件属性的正确类型验证
- **本地化随机名称**：添加中英文双语可爱随机名称生成，根据语言设置自动选择
  - 为英文和中文分别创建了形容词和名词库
  - 基于i18n设置实现了自动语言检测和名称生成
  - 使用localStorage跨会话保存用户名

### v0.2 - 增强型消息系统与图片支持
- **全面的图片系统**：实现了强大的消息类型框架和Base64编码传输，支持每条消息最多9张图片，优化了宽高比显示，确保在各种设备上无缝浏览
- **高级内容编辑器**：开发了支持混合内容的复杂编辑器，提供直观的剪贴板操作、智能光标定位和类似现代消息平台的自然编辑体验
- **性能与体验优化**：设计了节流机制和异步处理流程，确保处理大图片时的流畅操作，同时在所有设备类型上保持响应式用户界面

### v0.1 - 初始版本
- **核心消息系统**：基于Socket.IO实现实时消息传递，使用Redis进行数据持久化
- **房间管理功能**：创建了完整的房间创建、加入和访问控制系统
- **基础功能支持**：建立了多语言支持、主题切换和响应式设计原则

---

以上即为更新后的英文和中文 README 文件，两份文档中 API 接口部分均采用了更明确的路径参数设计，清晰表达了资源之间的层级关系。